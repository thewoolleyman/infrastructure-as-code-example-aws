### Infrastructure as Code Example - on Amazon Web Services

* This is a tutorial on [Infrastructure as Code](https://en.wikipedia.org/wiki/Infrastructure_as_Code)
on Amazon Web Services ("iaceaws").
* It will show you how to create a full stack, automatically and continuously deployed web app 
using Amazon Web Services tools.
* It also illustrates hot buzzwords such as Serverless, Functions as a Service, Event Sourcing, and
 Command Query Response Segregation.
* This presentation is provided by [GitPitch](https://gitpitch.com/)

---

### Goals and Philosophy

* It will walk you through every step of everything you need to do with working examples.
* After the initial manual bootstrapping, everything is automatically and continuously deployed.
* Emphasis on minimal working code to illustrate concepts being taught.
* Emphasis on minimal verbosity of instructions.  New things will be explained in depth only the 
first time - refer back,review prior steps, and read docs if you get lost.
* The CloudFormation pipeline template structure and naming is based on what is autogenerated by 
the AWS [CodeStar](https://aws.amazon.com/codestar/) tool.
* Unfortunately, CodeStar doesn't (yet) allow you to evolve more complex CloudFormation 
templates, so the alternative approach shown in this tutorial is to create your own templates 
from scratch.

---

### Non-Goals

* No emphasis on clean code, security, performance, or good architecture outside of the main 
topic, which is the CloudFormation template. (but it will attempt to point out where things could
 be done better, with references).
* It is a good practice to split up your infrastructure among multiple CloudFormation stacks, but
 we will keep everything in one monolithic stack. This is easier to follow, and it's not too big 
 for a simple app. 
* Not every instruction step and code will be detailed in slides. Instead, there will be just a 
summary of the changes done, a link to the corresponding tagged commit which implements the 
changes, and links to relevant docs to help you figure it out on your own.

---

### Requirements

* You should have some proficiency in and knowledge of the AWS Infrastructure as a Service, 
Javascript, HTTP APIs, git, the Linux command line, and other web development related topics.
* Instructions will be minimal after the initial manual bootstrapping. You should examine the 
corresponding commits and documentation links to understand what is going on, because it's all 
just [infrastructure as] code :)
* It is a good idea to become familar with
[AWS CloudFormation](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html),
[concepts](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-whatis-concepts.html),
and
[template design](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html),
they are not covered here. There is also a good
[Udemy course on CloudFormation](https://www.udemy.com/aws-cloudformation-master-class/).

---

### Disclaimer

* ***WATCH YOUR WALLET:*** This tutorial has you create a dedicated Amazon Web Services account, 
which requires a credit card to be entered.  Everything you do ***should*** fall under the "Free 
Tier", but if you create extra stuff or leave services running and get charged for anything, it's
 your responsibility.

---

### Implementation

* **TODO:** Every step is accompanied by a structured log emitted to CloudWatch in a way that is consumable
 by an observability tool such as [Honeycomb](https://honeycomb.io).  
* **TODO:** Every step has an associated acceptance test which asserts against the log output of 
the running application in order to verify that the step was implemented correctly.
  
---

### Process

* Everything is on the `master` branch, which shows incremental evolution by each commit.
* README and this presentation is entirely in the first commit
* Every commit has an associated tag which matches the number and name of the corresponding slide
 step.  This makes it easy to match up instructions with code.
* As this course is developed and updated over time, the `master` branch will be frequently 
updated, and thus the SHAs will change, but the tags will be continuously updated to point to the
new SHA for a given commit.
* The tags are continuously updated by
[git-revisionist-historian](https://github.com/thewoolleyman/git-revisionist-historian)
via
[CircleCI](https://circleci.com/gh/thewoolleyman/infrastructure-as-code-example-aws)
to keep tags up-to-date across rebases of master.  See
[`.circleci/README_AUTOTAGGER.md`](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/master/.circleci/README_AUTOTAGGER.md)
for details.
* This means you need to be on top of your git-fu when forking and cloning this repo!  See the
[README.md](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/master/README.md)
for more details.

---

### Let's Get Started!

* ***YOU DO NOT NEED TO FORK OR CLONE THIS REPO TO DO THIS TUTORIAL!  In fact, you probably 
shouldn't unless you know what you are doing. See the
[README.md](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/master/README.md)
for more details.***
* The first few steps will involve "Manual Bootstrapping", which means you will be performing 
infrastructure setup and actions directly in the AWS Web Console and Command Line Interface.  
However, as quickly as possible, we will get to the point of "fully automated", where all changes
 will be driven solely by making changes to the CloudFormation template and committing it, then they
 are automatically performed.  
* So, follow along, carefully read all instructions, commits, and docs, and have fun!

---

### Step 01 - Manual Bootstrapping - Create a dedicated AWS account

1. Go to [The AWS Console](https://console.aws.amazon.com/) and sign up for a new **personal** 
account. Consider creating a dedicated Gmail account for this, especially if you already have an 
existing AWS account under your main email. 
---

### Step 02 - Manual Bootstrapping - Log in to AWS account and create Access Key

1. Sign in to the AWS console using your ***root account credentials***.
  * ***NOTE: As a good security practice, ordinarily you should create an IAM user(s) for normal 
  work and not use the root account credentials. However, in keeping with our minimal 
  philosophy, and since we are only using it to bootstrap, we will just use the root user. All 
  you need is an Access Key for the user.  Your choice: you can create an IAM 'admin' user with 
  full admin access, or just use the root user***
1. Create an Access Key and save it somewhere safe:
   * 'Username' Dropdown -> My Security Credentials

---

### Step 03-00 - Manual Bootstrapping - Create an AWS CodeCommit repo

* Now we need a place to store our code. For ease of integration, we are going to
host our Git repo on AWS CodeCommit, but in addition you can push it to Github,
Gitlab, Bitbucket, or anywhere else you want.
* The instructions and code are on the slides below this one. Press your down arrow key to see them.

![Press Down Key](assets/down-arrow.png)

* There will be a highlighted down arrow at the lower right of the slide whenever there are more slides below in a step. 

+++
@title[Step 03-01 - Make a CloudFormation template with a CodeCommit repo]

### Step 03-01 - Make a CloudFormation template with a CodeCommit repo

* Create a new file `template.yml` in a temporary location (desktop or home directory).  You'll move
it into the repo after you create and clone it.
* You can review the
[AWS docs on the CloudFormation CodeCommit repository resource](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codecommit-repository.html)
for details.
* Paste in
[this CloudFormation template](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/03-01-bootstrapping-codecommit-repo/infra/template.yml)
and save the file.
* Note that this template contains a "CloudFormationTrustRole" resource, with very broad 
permissions to create and destroy AWS resources.  This is (as far as I can tell, I'm not an AWS 
Security expert) necessary for subsequent steps, where CloudFormation itself will be responsible
for this, as opposed to these early bootstrap steps, where you will be running Cloudformation 
updates yourself, via the GUI, using your the root/admin user authorization level. 

+++
@title[Step 03-02 - Create and deploy the stack]

### Step 03-02 - Create and deploy the stack

* In the AWS console, go to CloudFormation and create a new stack.
* **Services -> CloudFormation -> Create new Stack -> Choose a Template ->
Upload a template to Amazon S3 -> Choose file**
* Choose the `template.yml` file you created.
* Enter the "Stack Name" as `iaceaws`.  Leave the RepositoryName parameter as the
 default value of `iaceaws`.
* Click Next on the next screens then Create.
* Ensure it completes successfully. Look for green `CREATE_COMPLETE` status, and as the last 
status on the "Events" tab.
* View it in the CloudFormation Template Designer to see it represented in a GUI.  You can use the
Designer to see your stack evolve as you complete this tutorial.
  * NOTE: The Template Designer will always warn you that "Changes may not be saved..." when you 
  close it, even if you didn't make any changes.

+++
@title[Step 03-03 - Clone the CodeCommit repo]

### Step 03-03 - Clone the CodeCommit repo

* In the AWS Console, go to **Services -> CodeCommit**, click the repo, and follow the 
instructions to
[clone the repo](https://docs.aws.amazon.com/codecommit/latest/userguide/how-to-connect.html?icmpid=docs_acc_console#how-to-connect-http)
locally.
* You can use the AWS CLI and named profiles for credentials, e.g.:
  * `aws configure --profile iaceaws`
  * Use your Access Key for the new account (which you should have saved)
  * Verify you can see it: `aws codecommit --profile iaceaws list-repositories`
  * `git config --global credential.helper '!aws --profile iaceaws codecommit credential-helper $@'`
  * `git config --global credential.UseHttpPath true`
  * `git clone https://git-codecommit.us-east-2.amazonaws.com/v1/repos/iaceaws`
  * If you start getting 403's when trying to fetch the repo,
    [read this](https://docs.aws.amazon.com/codecommit/latest/userguide/troubleshooting-ch.html?icmpid=docs_acc_console_connect#troubleshooting-macoshttps)
  
+++
@title[Step 03-04 - Commit your CloudFormation template]

### Step 03-04 - Commit your CloudFormation template

* Now, move the `template.yml` file you created to `infra/template.yml` in your new repo, commit 
it, and push it.
* This file should exactly match the one in
[this commit](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/03-01-bootstrapping-codecommit-repo/infra/template.yml).
* This is a good time to get in the habit of checking the state of the code in your local repo 
against the corresponding tagged commit in the repo.  There's lots of ways to do this; you can pick 
what works for you.
* My preferred method is to:
  * Clone the
  [original repo](https://github.com/thewoolleyman/infrastructure-as-code-example-aws)
  and check out the appropriate tag.
  * Use one of [Jetbrains'](https://www.jetbrains.com/) IDEs to open your `iaceaws` repo directory 
  (you'll want to `.gitignore` the `.idea` folder).
  * In the Project file tree, right click on the file *or directory tree* you want to diff, and 
  "Compare With..."
  * This gives you a very nice directory-and-file level diff, and you can click the "<<" and "X" 
  marks to automatically add missing lines or delete incorrect ones.

---

### Step 04-00 - Manual Bootstrapping - Make a CodeBuild build which updates the stack

* This is the next step in our manual bootstrapping work (there's only one more after this one).
* The basic task we are accomplishing is to make Continuous Delivery setup to automatically and 
continuously deploy updates to our stack every time we push a change to the repo.  In 
steps 04 and 05, the only thing we are automating is the update of the CloudFormation stack itself,
 but it will lay the groundwork adding the other parts of our app in subsequent steps.
* We will set up a [CodeBuild](https://aws.amazon.com/codebuild/) project to run
[`aws cloudformation package`](https://docs.aws.amazon.com/cli/latest/reference/cloudformation/package.html)
for our CloudFormation template, which will export and upload the resulting packaged template as an 
artifact to an S3 bucket. We won't do anything with it yet, this is just a placeholder for the 
next step which actually auto-updates the stack.
* We will add a lot of new template code for our stack in these steps, but don't be intimidated! 
Carefully review the
[documentation for the corresponding Resource Types](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html)
 we are adding, and
 [you can understand it!](https://youtu.be/eaIvk1cSyG8)
* Press the down arrow to view the steps to set up your CodeBuild build.

+++
@title[Step 04-01 - add the Build Spec and script for the CodeBuild build project]

### Step 04-01 - add the Build Spec and script for the CodeBuild build project

* First, let's make the CodeBuild build. You may want to review the
[CodeBuild Build Spec Reference](https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html) 
* Create two new files in your cloned repo to setup CodeBuild:
  * The CodeBuild Build Spec:
    [`infra/codebuild/buildspec.yml`](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/04-02-add-codebuild-build-project/infra/codebuild/buildspec.yml)
  * The script for the CodeBuild `post_build` phase:
    [`infra/codebuild/post_build`](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/04-02-add-codebuild-build-project/infra/codebuild/post_build)
  * Make the script executable: `chmod +x infra/codebuild/post_build`

+++
@title[Step 04-02 - Update the stack to add the CodeBuild build project]

### Step 04-02 - Update the stack to add the CodeBuild build project

* Now lets update the template. Paste in
[the updated CloudFormation template](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/04-02-add-codebuild-build-project/infra/template.yml)
to your `infra/template.yml`.
* Save, commit, and push your changes.
* Go to your stack in the CloudFormation GUI, and check the box next to its name.
* **Actions -> Update stack** 
* Upload your updated `infra/template.yml`, and click **Next** until you get to the **Review** page.
* In the **"Capabilities"** section, you **MUST** check **"I acknowledge that AWS CloudFormation 
might create IAM resources with custom names."**.
[See the docs for more info](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-template.html?icmpid=docs_cfn_console#using-iam-capabilities)
* Click **"Update"**
* Make sure you see the 'UPDATE_COMPLETE' event to make sure it worked.

+++
@title[Step 04-03 - Manually run the CodeBuild build project]

### Step 04-03 - Manually run the CodeBuild build project

* Check out the CodeBuild view in the AWS Console - you should see your new build project which was 
created. 
* Note that pushes to the repo won't automatically trigger builds.  We could have set this
 up now, but we are about to set it up in a different way using a CodeDeploy pipeline in the next 
 step.
* Manually start a build for the `master` branch in CodeBuild.
* Ensure it completes successfully. You should see "Succeeded" for all steps in the "Phase 
Details".
* In the S3 view in the AWS Console, you should see your new S3 bucket, and the "placeholder.zip" 
which was uploaded to it, containing your
[packaged](https://docs.aws.amazon.com/cli/latest/reference/cloudformation/package.html)
`template-export.yml` file.

---

### Step 05-00 - Manual Bootstrapping - Hook up Continuous Deployment

* This is the last step which will involve manual bootstrapping work.
* We will update our stack to set up a 
[CodePipeline](https://aws.amazon.com/documentation/codepipeline/)
pipeline.
* This pipeline will automatically run our CodeBuild
[CodeBuild](https://aws.amazon.com/codebuild/)
project, which already packages and uploads the packaged CloudFormation template. Then it will 
use the `Deploy` action for the `AWS CloudFormation` provider to automatically update the stack.
* The following docs are useful to review:
  * [CodePipeline Pipeline Structure Reference](https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#action-requirements)

+++
@title[Step 05-01 - Update the stack to add the CodeDeploy pipeline]

### Step 05-01 - Update the stack to add the CodeDeploy pipeline

* When you're ready, paste in
[the updated CloudFormation template](https://github.com/thewoolleyman/infrastructure-as-code-example-aws/blob/05-01-add-codedeploy-pipeline/infra/template.yml)
to your `infra/template.yml`
* Add, commit, and push your changes, then upload the template and make sure your update completes 
successfully. 
* Check out your changes AWS GUI with the CloudFormation template editor.
* Go to the CodePipeline view and confirm all steps of your new pipeline completes successfully.

+++
@title[Step 05-02 - Verify that everything is now automated]

### Step 05-02 - Verify that everything is now automated

* TODO: flesh out
  * Make a no-op change to the template.yml
  * commit and push it
  * See it automatically updated in the CloudFormation template editor.

